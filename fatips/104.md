| FATIP | Title                         | Status | Category | Author                            | Created   |
| ----- | ----------------------------- | ------ | -------- | --------------------------------- | --------- |
| 104   | Contract Publication Standard | WIP    | Core     | Devon Katz\<<devonk@dbgrow.com>\> | 9-16-2019 |



# Summary

This standard describes a type of FATIP-107 Factom Data Store with specialized validation used to publish WebAssembly(WASM) contract bytecode to a Factom chain. This standard is used in conjunction with FATIP-0 to establish contracts at Factoid addresses, which then can be interacted with by users of FAT via transactions.

An Application Binary Interface(ABI) object structure is defined in this standard. The ABI lists the functions and arguments are available to be called in the contract, as well return types of those functions and is critical for interacting with contracts.

# Motivation

Our [proof of
concept](https://github.com/Factom-Asset-Tokens/wasm-contract-poc) successfully
demonstrated that raw WASM bytecode could successfully be stored published and
interpreted from the External Ids of Factom entry. While effective, this simple
system created a hard limit of 10KB in contract size as it used a single entry.

This standard uses the robust FATIP-107 datastore standard to publish WASM contract binaries to the Factom blockchain. FATIP-107 gives contract code a dedicated chain, allowing the reuse of established
and vetted contracts by chain Id. For example, an escrow contract established by a law firm
could be implemented directly by multiple different FAT tokens & contracts at
their addresses by specifying the chain Id of the contracts compiled source
code.

# Specification

This standard uses a FATIP-107 Data Store to host contract code and specify a contract ABI. Therefore, all functionality defined in this standard is built on top of the content, metadata, and name Ids of a FATIP-107 Data Store. No additional functionality is added to FATIP-107 as a result of this standard.

## Data Block Entries

The FATIP-107 Data Store data block entries shall be filled with the complete raw byte buffer of the compiled WASM bytecode.

The total size FATIP-107 content shall be limited to 100KB or less in final on-chain size, regardless of compression. Contract bytecode may be compressed as per FATIP-107 if desired.

## Content Metadata Object

The FATIP-107 Data Store metadata residing in the content object shall be used to define the contract's Application Binary Interface.

There is no limit on the number of functions or their respective arguments; however, the datastore content object must necessarily be less than 10KB in size as per Factom's per-entry size limit.

### Application Binary Interface

The ABI is a datastructure that defines how the higher level smart contract
platform interfaces with the low level binary WASM code. At it's heart a WASM
VM is a very low level machine which needs help understanding how to interpret
more complex types like strings from the host environment, and vice versa.

The ABI is defined in the root of the `metadata` key in the Content Metadata Object. All fields are inheritied and comply to FATIP-107's Content Metadata Object requirements.

### Content Metadata Object Example

```json
{
  "data-store": "1.0",
  "size": 999,
  "dbi-start": "4da6c4ba7c9f3d01a52df43ae5d67d7d8b3909babf6817463b8ceff3c74065ee",
  "metadata": {
      "_add":{
          "args":[
              "i32",
              "i32"
          ],
          "returns":"i32"
      }
  }
}
```

### Content Metadata Object Field Summary & Validation

Please note validation of fields inherited from FATIP-107 is not covered in this table.

| Name                  | Type   | Description                                                  | Validation                                                   | Required |
| --------------------- | ------ | ------------------------------------------------------------ | ------------------------------------------------------------ | -------- |
| `metadata[*]`         | string | The full function name                                       |                                                              | Y        |
| `metadata[*].args`    | array  | The ordered array of argument types that the function signature accepts. | All elements must be strings. Must be one of the [Supported Argument And Return Types](https://github.com/Factom-Asset-Tokens/FAT/blob/FATIP-S-Smart-Contracts-And-Supporting-Standards/fatips/104.md#Supported-Arguments-and-Return-Types) | Y        |
| `metadata[*].returns` | string | The type of return value to expect from the function         | Must be a string. Must be one of the [Supported Argument And Return Types](https://github.com/Factom-Asset-Tokens/FAT/blob/FATIP-S-Smart-Contracts-And-Supporting-Standards/fatips/104.md#Supported-Arguments-and-Return-Types) | Y        |
|                       |        |                                                              |                                                              |          |

##### Supported Arguments and Return Types

- `i32` - 32 Bit integer
- `i64` - 64 Bit integer
- `f32` - 32 Bit float
- `f64` - 64 Bit float
- `string` - `i32` pointer to an array of null terminated character bytes in
  linear memory
- `array[i32]` -  `i32` pointer to an array of `i32` bytes in linear memory
- `array[i64]` -  `i32` pointer to an array of `i64` bytes in linear memory
- `array[f32]` -  `i32` pointer to an array of `f32` bytes in linear memory
- `array[f32]` -  `i32` pointer to an array of `f64` bytes in linear memory

##### Functions

For a contract function to be callable externally it must exist in the ABI
object. Typically C compilers and linkers will append an underscore onto the
function name in code when making an exported function available. For example,
in C `add(int x)` will be exported as `_add `.

Note that it is only possible to derive a function's name, not it's signature
from a WebAssembly binary. The publisher must to declare the proper function
argument types, counts, and ordering in the ABI to avoid undefined behavior.



## Contract Validation

The contract residing in the FATIP-107 Data Store must be validated to be considered a valid FAT compatible contract:

- The resulting data bust be a valid WASM binary (See this standard's [Implementation](#Implementation) section for tooling notes)
- All functions defined inside the ABI must be present in the compiled contract and externally callable by the host environment. However, it is not required that all internal or external functions in the contract be defined in the ABI so as to restrict host access to certain functions within the contract.



# Implementation

The official [WebAssembly Toolkit
(WABT)](https://github.com/WebAssembly/wabt)'s
[wasm-validate](https://webassembly.github.io/wabt/doc/wasm-validate.1.html)
command line tool is a very popular way of validating WASM binaries.


# Copyright

Copyright and related rights waived via
[CC0](https://creativecommons.org/publicdomain/zero/1.0/).
